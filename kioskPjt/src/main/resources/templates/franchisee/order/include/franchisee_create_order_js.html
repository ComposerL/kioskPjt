<script th:fragment="js" type="text/javascript">
$(document).ready(function() {
    // 페이지가 로드되면 카테고리와 메뉴들을 가져오는 함수 호출
    ajax_getCategorie();
    
    orderBtnClick();
    
    init();
    
});

function init() {
    console.log('init()')

}

function removeOrderTable(){
    console.log('removeOrderTable()')

    $('#order_table').empty();

}
 
//카테고리
function ajax_getCategorie() {
    console.log('ajax_getCategorie');

    $.ajax({
        url: '/franchisee/order/getCategory',
        method: 'get', // GET 요청으로 변경
        dataType: 'json',
        success: function(data) {
            console.log('cateajsx success!!')
            let cateDtos = data.categoryDtos;

            // 이전 카테고리 제거
            $('#order_category_select').empty();

            for (let i = 0; i < cateDtos.length; i++) {
                // 카테고리 옵션 추가
                $('#order_category_select').append(
                    '<option value="' + cateDtos[i].fcmc_no + '">' +
                    cateDtos[i].fcmc_name + '</option>');
            }
        },
        error: function(data) {
            console.log('CATEajax error!!');
        },
        complete: function(data){
        	console.log('CATEajax complate!!');
        	
        	ajax_get_order_by_category();
        	
        	// 카테고리가 변경될 때마다 해당 카테고리의 메뉴를 가져오는 함수 호출
        	$('#order_category_select').change(function() {
        		console.log("order_category_select change!!!!");
        	    // ajax_get_order_by_category($(this).val());
        	    ajax_get_order_by_category();
        	}); 
        }
    });
}

//메뉴
function ajax_get_order_by_category() {
    console.log('ajax_get_menus_by_category()');
    	
    let fcmc_no = $('#order_category_select').val();
    console.log('fcmc_no:>>>>>',fcmc_no);
    
    $.ajax({
        url: '/franchisee/order/getMenusByCategory',
        method: 'get',
        data: 'fcmc_no=' + fcmc_no, // 문자열 형태로 데이터 전달
        dataType: 'json',
        success: function(data) {
            console.log('menuajsx success!!');
            let menuDtos = data.franchiseeMenusDtos;
            let appendTag = '';

            $('#order_menu_select').empty();
                      
            	for (let i = 0; i < menuDtos.length; i++) {
                appendTag += '<option value="' + menuDtos[i].fc_menu_no + '">';
                appendTag += menuDtos[i].fc_menu_name;
                appendTag += '</option>';
            }

            $('#order_menu_select').html(appendTag);
            
        },
        error: function(data) {
            console.log('ajax error!!');
        },
        complete: function(date) {
        	console.log('ajax complete');
        	console.log("fc_menu_no: ",$('#order_menu_select').val());
        	
        	ajax_get_price_by_category();
        	
        	$('#order_menu_select').change(function() {
        		console.log("order_menu_select change!!!!");
        		
        		
        		ajax_get_price_by_category();
        	}); 
        }
    });

}

// 돈 불러오기

function ajax_get_price_by_category() {
    console.log('ajax_get_price_by_category()');
    	
    let fc_menu_no = $('#order_menu_select').val();
    
    console.log('fc_menu_no:>>>>>',fc_menu_no);
    
    $.ajax({
        url: '/franchisee/order/getPriceByCategory',
        method: 'get',
        data: 'fc_menu_no=' + fc_menu_no, // 문자열 형태로 데이터 전달
        dataType: 'json',
        success: function(data) {
            console.log('pricejsx success!!');
            let priceDtos = data.franchiseePriceDtos;
            let appendTag = priceDtos[0].fc_menu_price;
                       
            $('.basic_price').val(appendTag);
                            			         	
        },
        error: function(data) {
            console.log('ajax error!!');
        },
    });

}

// 가맹점 정보 

/* function ajax_store_select() {
    console.log('ajax_store_select');
      
    $.ajax({
        url: '/franchisee/order/getStoreInfo',
        method: 'get',
        dataType: 'json',
        success: function(data) {
            console.log('Storejsx success!!');
            
            let storeDtos = data.franchiseeStoreDto;

            $('#order_store_select').empty();
            
            for (let i = 0; i < storeDtos.length; i++) {
                // 카테고리 옵션 추가
                $('#order_store_select').append(
                    '<option value="' + storeDtos[i].fcm_no + '">' +
                    storeDtos[i].fcs_name + '</option>');
            }
        },
        error: function(xhr, status, error) {
            console.log('Storejsx error:', error);
        },
    });
}
 */


function orderBtnClick() {
	console.log("orderBtnClick()")
    // "메뉴등록" 버튼 클릭 이벤트 핸들러
   
	/* orderBtnClick(); */
    $('#order_btn').click(function() {
   		
       // 선택된 카테고리와 메뉴 가져오기      
        let packaging = $('#order_packaging_select option:selected').val();     // 포장 여부
        let pay = $('#order_payment_select option:selected').text();            // 결제 방법
        let category = $('#order_category_select option:selected').val();       // 메뉴 카테코리 NO
        let menu = $('#order_menu_select option:selected').val();
        let quantity = parseInt($('.basic_count').val());       // 주문 수량 가져오기
        let price = parseInt($('.basic_price').val());          // 주문 가격 가져오기
        let shot_number = $('.shot_number').val();
        let pur_number = $('.pur_number').val();
        let fc_menu_option_price = parseInt(shot_number * 500) + (pur_number * 1000);
        let fco_total_price = (fc_menu_option_price + price) * quantity;

        let cof_packaging = $('#order_packaging_select').val();
        let cof_pay = $('#order_payment_select').val();

        if(cof_packaging === '' || cof_pay === '') {
            alert("포장 여부 or 결제 방식을 선택하세요.")

        } else {
            // 주문 목록에 추가
            let appendTag = "<tr>";
                    appendTag += '<td fco_packaging="'+packaging+'">' + $('#order_packaging_select option:selected').text() + '</td>';    
                    appendTag += '<td pm_type="'+pay+'">' + pay + '</td>';    
                    appendTag += '<td fcmc_no="'+category+'">' + $('#order_category_select option:selected').text() + '</td>';
                    appendTag += '<td fc_menu_no="'+menu+'">' + $('#order_menu_select option:selected').text() + '</td>';
                    appendTag += '<td fco_menu_cnt="'+quantity+'">' + quantity + '</td>';
                    appendTag += '<td>샷: '+ shot_number + ' , 펄: ' + pur_number + '</td>';
                    appendTag += '<td fco_total_price="'+fco_total_price+'" fc_menu_option_price="'+fc_menu_option_price+'">'+fco_total_price+'</td>';
                    appendTag += '<td>' + new Date().toLocaleDateString() + '</td>'; // 현재 날짜를 주문일로 설정
                appendTag += '</tr>';
            
            $("#order_table").append(appendTag);

            $('input.shot_number').val(0);

            $('input.pur_number').val(0);
        }

   });

    $('#section_wrap input[name="AllOrder_btn"]').click(function() {
  		// 클릭 이벤트 발생 시 실행되는 코드
  		console.log(" eliments: --->>>", $('#order_table tr:nth-child(1) td').length);

        ajax_get_AllOrder_by_order();
  	})
  	
      $('#section_wrap input[name="AllOrder_delete_btn"]').click(function() {
        console.log('AllOrder_delete_btn click()');

  		$('#order_table').empty();

  	});

}

function ajax_get_AllOrder_by_order() {	
	
		console.log('AllOrder_btn clicked');		
		
		let menuOrders = [];  
		
	    for(let i = 1, j = 0; i <= $("#order_table tr").length;  i++, j++){
			
            let fco_packaging = $('#order_table tr:nth-child('+i+') td:nth-child(1)').attr("fco_packaging");
            let pm_type = $('#order_table tr:nth-child('+i+') td:nth-child(2)').attr("pm_type");
            let fcmc_no = $('#order_table tr:nth-child('+i+') td:nth-child(3)').attr("fcmc_no");
            let fc_menu_no = $('#order_table tr:nth-child('+i+') td:nth-child(4)').attr("fc_menu_no");
            let fco_menu_cnt = $('#order_table tr:nth-child('+i+') td:nth-child(5)').attr("fco_menu_cnt");
            let fco_menu_option = $('#order_table tr:nth-child('+i+') td:nth-child(6)').text();
            let fco_total_price = $('#order_table tr:nth-child('+i+') td:nth-child(7)').attr("fco_total_price");
            let fco_menu_option_price = $('#order_table tr:nth-child('+i+') td:nth-child(7)').attr("fc_menu_option_price");

            // 'shot_number' : shot_number,
            // 'shot_price' : shot_price,
            // 'pur_number' : pur_number,
            // 'pur_price' : pur_price,

            
            menuOrders[j] = {
		    		"fco_packaging" : fco_packaging,
		    		"pm_type" : pm_type,
		    		"fcmc_no" : fcmc_no,
			        "fc_menu_no" : fc_menu_no,
		         	"fco_menu_cnt" : fco_menu_cnt,
                    "fco_menu_option" : fco_menu_option,
                    "fco_menu_option_price" : fco_menu_option_price,
                    "fco_total_price" : fco_total_price
		     	}		 

        }
	    
	    console.log("menuOrders: ", menuOrders);
		
	    dataMsg = {
	    		'menuOrders': menuOrders,
	    };
	    
	    $.ajax({
			 url: '/franchisee/order/OrderAccountConfirm',
		     method: 'post',
		     /* data: JSON.stringify(menuOrders), */
		     data: JSON.stringify(dataMsg),
		     contentType: 'application/json; charset=utf-8',
		     dataType: 'json',	
		     success: function(data) {
		   	 	console.log('order_ajax success!!');

                removeOrderTable();

            },
		     
			error: function(data) {
	        	console.log('order_ajax error!!');
	        
			}
		     
		});

} 


 
</script>
