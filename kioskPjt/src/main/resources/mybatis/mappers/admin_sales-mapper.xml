<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.office.kiosk.admin.sales.IAdminSalesDao">
	
	<select id="selectAllSalesInfo" 
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto" >
	
		SELECT 
			*
		FROM 
			TBL_FC_SALES FCSA 
		JOIN 
			TBL_FC_STORE FCS 
		ON 
			FCSA.FCS_NO = FCS.FCS_NO
		ORDER BY 
			FCSA_NO DESC 
	
	</select>
	
	<!-- all sales list page cnt -->
	<select id="selectAllSalesListCnt" 
			parameterType="Integer">
	
		SELECT 
			COUNT(FCSA_NO) 
		FROM TBL_FC_SALES 
		WHERE DATE(FCSA_REG_DATE) = CURDATE() 
	
	</select>
	
	<select id="selectSalesListForPaging" 
			parameterType="map" 
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto">
			
		SELECT 
			* 
		FROM 
			TBL_FC_SALES FCSA 
		JOIN 
			TBL_FC_STORE FCS 
		ON 
			FCSA.FCS_NO = FCS.FCS_NO
		JOIN 
			TBL_FC_MEMBER FCM 
		ON 
			FCM.FCM_NO = FCS.FCM_NO 
		WHERE DATE(FCSA_REG_DATE) = CURDATE() 
		ORDER BY 
			FCSA_NO DESC
		LIMIT 
			#{start},#{limit} 
	
	</select>
	
	<!-- ajax 전체 sales 목록 가져오기 -->
	<select id="selectAllSalesInfoForAjax" 
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto" >
	
		SELECT 
			* 
		FROM 
			TBL_FC_SALES FCSA 
		JOIN 
			TBL_FC_STORE FCS 
		ON 
			FCSA.FCS_NO = FCS.FCS_NO
		JOIN 
			TBL_FC_MEMBER FCM 
		ON 
			FCM.FCM_NO = FCS.FCM_NO 
		WHERE DATE(FCSA.FCSA_REG_DATE) = CURDATE() 
		ORDER BY 
			FCSA_NO DESC 
	
	</select>
	
	<!-- 선택 ori_no order info 가져오기 -->
	<select id="selectOrderInfoByOriNo"
			parameterType="Integer"
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto">
			
		SELECT 
			FCS_NAME, 
		    FCS_LOCATION,
		    FCS_PHONE, 
		    FCM_NAME, 
		    FCO.FCO_NO,
			FCO.FCO_ORI_NO, 
		    FCO.PM_TYPE, 
		    FCO.FC_MENU_NO, 
		    FCO_MENU_CNT, 
		    M.FC_MENU_NAME, 
		    M.FC_MENU_PRICE, 
		    FCSA.FCSA_REG_DATE, 
		    FCSA.FCSA_PRICE 
		FROM TBL_FC_ORDER FCO
		JOIN TBL_FC_STORE FCS ON FCS.FCS_NO = FCO.FCS_NO 
		JOIN TBL_FC_MEMBER FCM ON FCM.FCM_NO = FCS.FCM_NO 
		JOIN TBL_FC_MENU M ON M.FC_MENU_NO = FCO.FC_MENU_NO
		JOIN TBL_FC_SALES FCSA ON FCSA.FCO_ORI_NO = FCO.FCO_ORI_NO 
		WHERE FCO.FCO_ORI_NO = #{fco_ori_no} 
			
	</select>
	
	<!-- ajax fcs_name, 기간별 sales 목록 가져오기 -->
	<!-- ajax fcm_name, 기간별 sales 목록 가져오기 -->
	<!-- ajax pm_type, 기간별 sales 목록 가져오기 -->
	<select id="selectSalesInfo"
			parameterType="com.office.kiosk.franchisee.dto.SearchSalesDto" 
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto" >
			
		SELECT 
			* 
		FROM 
			TBL_FC_SALES FCSA 
		JOIN 
			TBL_FC_STORE FCS 
		ON 
			FCSA.FCS_NO = FCS.FCS_NO 
		JOIN 
			TBL_FC_MEMBER FCM 
		ON 
			FCM.FCM_NO = FCS.FCM_NO 
		<where>
			FCSA_REG_DATE BETWEEN
            <choose>
                <when test="search_term == '1d'">
                    DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                </when>
                <when test="search_term == '1w'">
                    DATE_SUB(CURDATE(), INTERVAL 1 WEEK)
                </when>
                <when test="search_term == '1m'">
                    DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                </when>
                <when test="search_term == '6m'">
                    DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
                </when>
                <when test="search_term == '1y'">
                    DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
                </when>
                <otherwise>
                    DATE_SUB(CURDATE(), INTERVAL 100 YEAR)
                </otherwise>
            </choose>
        	AND NOW()
		AND 
			<choose>
				<when test="search_value == 'fcs_name'">
					FCS.FCS_NAME LIKE '%${search_word}%' 
				</when>
				<when test="search_value == 'fcm_name'">
					FCM.FCM_NAME LIKE '%${search_word}%' 
				</when>
				<when test="search_value == 'pm_type'">
					FCSA.PM_TYPE LIKE '%${search_word}%' 
				</when>
			</choose>
		</where>
	
	</select>
	

	
	<!-- 가맹점별 총 매출 조회 -->
	<select id="selectStoreTotalSales" 
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto">
	
		SELECT
		    FCSA.FCS_NO,
		    FCS.FCS_NAME,
		    FCM.FCM_NAME,
		    SUM(CASE WHEN FCSA.PM_TYPE = '카드' THEN FCSA.FCSA_PRICE END) AS CARD_TOTAL_PRICE,
		    SUM(CASE WHEN FCSA.PM_TYPE = '현금' THEN FCSA.FCSA_PRICE END) AS CASH_TOTAL_PRICE
		FROM TBL_FC_SALES FCSA 
		JOIN TBL_FC_STORE FCS ON FCS.FCS_NO = FCSA.FCS_NO
		JOIN TBL_FC_MEMBER FCM ON FCM.FCM_NO = FCS.FCM_NO
		WHERE DATE(FCSA.FCSA_REG_DATE) = CURDATE() 
		GROUP BY FCS_NO 
	
	</select>
	
	<!-- 특정 날짜 가맹점별 매출 조회 -->
	<select id="selectDateTotalSales" 
			parameterType="String"
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto">
	
		SELECT 
		    FCSA.FCS_NO, 
		    FCS.FCS_NAME, 
		    FCM.FCM_NAME, 
		    SUM(CASE WHEN FCSA.PM_TYPE = '카드' THEN FCSA.FCSA_PRICE END) AS CARD_TOTAL_PRICE, 
		    SUM(CASE WHEN FCSA.PM_TYPE = '현금' THEN FCSA.FCSA_PRICE END) AS CASH_TOTAL_PRICE 
		FROM TBL_FC_SALES FCSA 
		JOIN TBL_FC_STORE FCS ON FCS.FCS_NO = FCSA.FCS_NO 
		JOIN TBL_FC_MEMBER FCM ON FCM.FCM_NO = FCS.FCM_NO 
		WHERE DATE(FCSA.FCSA_REG_DATE) = #{selectDate} 
		GROUP BY FCS_NO  
	
	</select>
	
	<!-- 선택기간 가맹점별 매출 조회 -->
	<select id="selectStoreSalesDtosByInputFeriod"
			parameterType="map"
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto">
			
		SELECT 
		    FCSA.FCS_NO, 
		    FCS.FCS_NAME, 
		    FCM.FCM_NAME, 
		    SUM(CASE WHEN FCSA.PM_TYPE = '카드' THEN FCSA.FCSA_PRICE END) AS CARD_TOTAL_PRICE, 
		    SUM(CASE WHEN FCSA.PM_TYPE = '현금' THEN FCSA.FCSA_PRICE END) AS CASH_TOTAL_PRICE 
		FROM TBL_FC_SALES FCSA 
		JOIN TBL_FC_STORE FCS ON FCS.FCS_NO = FCSA.FCS_NO 
		JOIN TBL_FC_MEMBER FCM ON FCM.FCM_NO = FCS.FCM_NO 
		WHERE FCSA.FCSA_REG_DATE BETWEEN #{startDate} AND #{endDate} 
		GROUP BY FCS_NO 
			
	</select>

	<!-- 회원별 총 매출 조회 -->
	<select id="selectFranchiseeTotalSales" 
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto">
	
		SELECT 
			FCM.FCM_NO,
		    FCM.FCM_NAME,
			SUM(CASE WHEN FCSA.PM_TYPE = '카드' THEN FCSA.FCSA_PRICE END) AS CARD_TOTAL_PRICE,
		    SUM(CASE WHEN FCSA.PM_TYPE = '현금' THEN FCSA.FCSA_PRICE END) AS CASH_TOTAL_PRICE
		FROM 
			TBL_FC_MEMBER FCM 
		JOIN TBL_FC_STORE FCS ON FCS.FCM_NO = FCM.FCM_NO 
		JOIN TBL_FC_SALES FCSA ON FCS.FCS_NO = FCSA.FCS_NO 
		WHERE DATE(FCSA.FCSA_REG_DATE) = CURDATE() 
		GROUP BY FCM_NO;
	
	</select>
	
	<!-- 특정 날짜 회원별 매출 조회 -->
	<select id="selectDateFranchiseeTotalSales" 
			parameterType="String"
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto">
	
		SELECT 
			FCM.FCM_NO,
		    FCM.FCM_NAME,
			SUM(CASE WHEN FCSA.PM_TYPE = '카드' THEN FCSA.FCSA_PRICE END) AS CARD_TOTAL_PRICE,
		    SUM(CASE WHEN FCSA.PM_TYPE = '현금' THEN FCSA.FCSA_PRICE END) AS CASH_TOTAL_PRICE
		FROM 
			TBL_FC_MEMBER FCM 
		JOIN TBL_FC_STORE FCS ON FCS.FCM_NO = FCM.FCM_NO 
		JOIN TBL_FC_SALES FCSA ON FCS.FCS_NO = FCSA.FCS_NO 
		WHERE DATE(FCSA.FCSA_REG_DATE) = #{selectDate}
		GROUP BY FCM_NO;
	
	</select>
	
	<!-- 선택 기간 회원별 매출 조회 -->
	<select id="selectFranchiseeSalesDtosByInputFeriod" 
			parameterType="map" 
			resultType="com.office.kiosk.franchisee.sales.FranchiseeSalesDto">
	
		SELECT 
			FCM.FCM_NO,
		    FCM.FCM_NAME,
			SUM(CASE WHEN FCSA.PM_TYPE = '카드' THEN FCSA.FCSA_PRICE END) AS CARD_TOTAL_PRICE,
		    SUM(CASE WHEN FCSA.PM_TYPE = '현금' THEN FCSA.FCSA_PRICE END) AS CASH_TOTAL_PRICE
		FROM 
			TBL_FC_MEMBER FCM 
		JOIN TBL_FC_STORE FCS ON FCS.FCM_NO = FCM.FCM_NO 
		JOIN TBL_FC_SALES FCSA ON FCS.FCS_NO = FCSA.FCS_NO 
		WHERE FCSA.FCSA_REG_DATE BETWEEN #{startDate} AND #{endDate} 
		GROUP BY FCM_NO 
	
	</select>
	


</mapper>